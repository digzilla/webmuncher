<html>

<script src="js/PaPaParse-4.1.2/papaparse.js"></script>

<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="js/Proj4Leaflet-1.0.1/lib/proj4.js"></script>
<script src="js/Proj4Leaflet-1.0.1/src/proj4leaflet.js"></script>

<script src="js/gbify-geojson-master/index.js"></script>

<script src="js/jsonQ-master/jsonQ.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />

<!--<input type="file" id="input"></input>-->

<input type="button" id="goButton" value="show me the CSV" onClick="showCSV();">
<div id="rawOutput"><h2>All Data:</h2></div>
<div id="uniqueOutput"><h2>Unique Point Names:</h2></div>
<div id="uniqueCoordOutput"><h2>GeoJSON</h2></div>
<div id="mapid" style="height: 800px"></div>
<div id="register"><h2>Data Register</h2></div>


<script>

function showCSV() {
  //var textData = Papa.parse("data/NNIT-01-151201-cd.csv", {
  var textData = Papa.parse("data/AFOR-survey-combined-v02-tidied.csv", {
  //var textData = Papa.parse("data/ETEX17-170207.csv", {
      download: true,
      delimiter: ",",
      complete: function(results) {
        console.log(results);
        jsonToTable(results);
        jsonToUniqueNamesList(results);
        //jsonToGeoJSON(results);
        makeRegister(results);
      }
})};

function jsonToTable(inputJSON) {
  var txt = "<table border='1'>";
  for (x in inputJSON.data) {
      txt +="<tr>"
      for (y in inputJSON.data[x]) {
        txt += "<td>" + inputJSON.data[x][y] + "</td>";
      }
      txt += "</tr>";
  }
  txt += "</table>";
  document.getElementById("rawOutput").innerHTML += txt;

}

function jsonToUniqueNamesList(inputJSON){
  var txt = "<table border='1'>";
  var uniqueNames = [];
  var z = 0;
  for (x in inputJSON.data) {
    name = inputJSON.data[x][0].slice(0, inputJSON.data[x][0].lastIndexOf("-"));
    if (uniqueNames.Length == 0) {
      uniqueNames.push(name);
      txt +="<tr><td>" + name + "</td></tr>";
      z++;
    } else {
      if (uniqueNames[z-1]!=name) {
        uniqueNames.push(name);
        txt +="<tr><td>" + name + "</td></tr>";
        z++;
      }
    }
  }
  txt += "</table>";
  document.getElementById("uniqueOutput").innerHTML += txt;
}

function jsonToGeoJSON(inputJSON){

  var txt //= "<table border='1'>";
  var masterGeoJSON = {"type": "FeatureCollection",
    "crs":{
      "type": "name",
      "properties":
        {"name":"urn:ogc:def:crs:EPSG::27700"}
      },
    "features":[]
    };
  var z = 0;
  for (x in inputJSON.data) {
    name = inputJSON.data[x][0].slice(0, inputJSON.data[x][0].lastIndexOf("-"));
    var shapeData = {
      "type": "Feature",
      "id": inputJSON.data[x][0], //is this needed?
      "properties": {
        "pointname": inputJSON.data[x][0],
        "height": inputJSON.data[x][3],
        "code": inputJSON.data[x][4]
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          parseFloat(inputJSON.data[x][1]),
          parseFloat(inputJSON.data[x][2])
      ]
    }
  };
      if (shapeData.id!="") { //filters out annoying last one with no data
      masterGeoJSON.features.push(shapeData);
    };

  };

console.log(masterGeoJSON);
document.getElementById("uniqueCoordOutput").innerHTML += JSON.stringify(masterGeoJSON);

//var crs = new L.Proj.CRS('EPSG:27700',
  //'+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs'
//);

proj4.defs('EPSG:27700', '+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs');

var mymap = L.map('mapid').setView([55.95,-3.21],11);

// create the tile layer with correct attribution
var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
var osmAttrib='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
var osm = new L.TileLayer(osmUrl, {minZoom: 8, attribution: osmAttrib});
mymap.addLayer(osm);

//this works
L.Proj.geoJson(masterGeoJSON, {'pointToLayer': function(feature, latlng) {
  return L.marker(latlng).bindPopup(feature.properties.pointname);
  }
}).addTo(mymap);

//this doesn't work - no idea how to use a javascript plugin
//var webGeoJSON = gbify.toWGS84(masterGeoJSON);
//L.geoJson(webGeoJSON).addto(mymap);

}

function makeRegister(inputJSON) {

  var masterRegister = {};
  masterRegister.items = [];

  for (x in inputJSON.data) {
    name = inputJSON.data[x][0].slice(0, inputJSON.data[x][0].lastIndexOf("-"));
    var test = searchNames(masterRegister,name);
    if (test >= 0) {
      console.log(name+" already exists");
      masterRegister.items[test].pointcount = parseInt(masterRegister.items[test].pointcount)+1;
    } else {
      var shapeData = {"name":name, "pointcount":1};
      masterRegister.items.push(shapeData);
    }
  };

  //remove last annoying entry
  masterRegister.items.splice(-1);
  console.log(masterRegister);
  var sorted = {};
  sorted.items = jsonQ.sort(masterRegister.items);
  console.log(sorted);

  var tableText = "<table>"
  for (x in sorted.items) {
    console.log(x.name);
    tableText += "<tr><td>" + sorted.items[x].name + "</td><td>"+sorted.items[x].pointcount+" points</td></tr>";
  }
  tableText +="</table>";
  document.getElementById("register").innerHTML += tableText;

}

function searchNames(master, name) {
if (master.items == "undefined"){
  return -1;
} else {
  for (x in master.items) {
    if (master.items[x].name == name) {
      return x;
    }
  }
}
}

</script>


</html>
